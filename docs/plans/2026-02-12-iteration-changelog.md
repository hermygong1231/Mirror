# 棱镜 · 迭代记录

> 最后更新：2026-02-12

---

## 阶段一：MVP 核心流程搭建（2/9 - 2/10）

### 1.1 决策输入三步向导

实现了完整的 3 步决策录入流程：

| 步骤 | 页面 | 核心功能 |
|------|------|----------|
| Step1 决策是什么 | `create/step1` | 决策描述、选项列表（最多 5 个）、倾向选择、决策日期、AI 智能标签 |
| Step2 为什么选择 | `create/step2` | 选择理由、恐惧/担心（特殊高亮样式）、5 种情绪选择、情绪补充 |
| Step3 预期与复盘 | `create/step3` | 预期输入、复盘周期选择（1 周 / 1 月 / 3 月 / 6 月）、提交云数据库 |

**技术要点**：
- 跨步骤数据通过 `draft_step1` / `draft_step2` 在 localStorage 中传递
- 每步页面卸载时自动保存草稿，重新进入自动恢复
- 前端直接操作云数据库 `decisions` 集合，未走云函数

### 1.2 AI 智能标签（本地版）

Step1 输入决策内容后，800ms 防抖触发本地关键词匹配分析，自动推测：
- **分类**：产品 / 投资 / 工作 / 人生（4 组关键词库，各 20+ 词）
- **风险等级**：低 / 中 / 高
- **可逆性**：可逆 / 不可逆

用本地关键词匹配替代了设计文档中的 AI 调用，零成本且响应即时。标签支持手动修改。

### 1.3 决策列表页

`decisions/list` 作为默认首页，实现了：
- **Tab 筛选**：全部 / 待复盘 / 已复盘（前端内存筛选）
- **搜索**：按决策内容、选项、分类关键词搜索（300ms 防抖）
- **分页加载**：每页 20 条，触底加载更多
- **卡片信息**：状态标签、日期、标题、选项、分类、情绪 emoji、复盘日期

### 1.4 左滑操作

自定义手势实现（非 movable-view）：
- 未复盘卡片：左滑显示「删除」
- 已复盘卡片：左滑显示「重写复盘」+「删除」
- 方向锁定：水平滑动与垂直滚动互斥
- 删除操作带确认弹窗
- 重写复盘：清除 review / aiAnalysis / feedback 后跳转复盘流程

---

## 阶段二：复盘 + AI 分析（2/10 - 2/11）

### 2.1 复盘流程（3 页面）

| 页面 | 功能 |
|------|------|
| `review/recall` | 回顾原始决策全部信息 + 时间距离标签（"N 天前的决策"） |
| `review/input` | 正面/负面双路径复盘输入 |
| `review/result` | AI 分析结果展示 + 破壁反馈 |

### 2.2 正面/负面双路径复盘

不只分析失败决策，也分析成功决策：

- **做对了 (positive)**：填写成功原因 → 选择成功类型（判断准确 / 执行到位 / 都做对了）→ 选择成功因素（心态稳定 / 信息充分 / 好的建议 / 资源充足）
- **做错了 (negative)**：填写错误假设 → 选择错误类型（判断错 / 执行错 / 都有）→ 选择影响因素（情绪 / 新信息 / 外部压力 / 资源变化）

切换正面/负面时自动重置下游字段。

### 2.3 AI 分析引擎

**三层降级策略**：
1. DeepSeek R1（`wx.cloud.extend.AI.createModel('deepseek')`，前端直连）
2. 混元 Lite（DeepSeek 失败时自动降级）
3. 本地规则分析（大模型全挂时的兜底）

**两套 Prompt**：
- 负面分析：「认知偏差识别专家」角色，犀利直接，输出偏差类型 + 行为模式 + 建议原则
- 正面分析：「决策教练」角色，帮用户把运气变成能力，输出思维优势标签

**结构化输出**：summary、coreIssue、biasTypes / strengthTags、currentPattern、suggestedPrinciple、suggestion、confidence

### 2.4 等待体验设计

AI 分析需要 5-15 秒，设计了仪式感等待动画：
- 脑图波纹扩散动画（CSS）
- 28 条经典金句轮播（4 秒切换，淡入淡出）
- 进度点动画

### 2.5 破壁反馈机制

分析结果页底部：「这次分析有没有打破你的认知？」
- 🔨 破壁了 / 🧱 没破
- 反馈写入 `decisions` 集合的 `feedback` 字段
- 用于后续统计「破壁率」，衡量 AI 分析质量

### 2.6 数据导出

列表页支持导出全部决策数据：
- **JSON 格式**：完整结构化数据
- **Markdown 格式**：可阅读的决策记录文档
- 导出方式：发送给好友 / 文件传输助手 / 复制到剪贴板

---

## 阶段三：AI Agent 聊天 + 知识库（2/11）

### 3.1 AI 聊天机器人

`chatBot/chatBot` 页面接入微信云开发 `agent-ui` 组件：
- 模型：DeepSeek v3.2
- 支持：联网搜索、文件/图片上传、语音输入、多轮对话

### 3.2 认知偏差知识库

从 The Decision Lab 精选 15 个核心认知偏差，整理为结构化知识库：

确认偏差、沉没成本谬误、乐观偏差、锚定偏差、达克效应、规划谬误、损失厌恶、框架效应、现状偏差、可得性启发法、后见之明偏差、从众效应、控制错觉、选择过载、禀赋效应

每个偏差包含：定义、真实案例、决策场景表现、解毒方法。附偏差叠加关联表。

### 3.3 决策框架与自欺模式库

- **决策框架**：预验尸法、10/10/10 法则、贝佐斯双向门理论、反转测试
- **自欺模式**：完美主义伪装的恐惧、防御性决策、伪勤奋陷阱、预留借口

---

## 阶段四：新手引导系统（2/12）

### 4.1 预置示例决策

新用户首次进入列表页，自动插入一条「待复盘」示例决策：
- 内容：「周末花一整天学新技能，还是好好休息？」
- `reviewDate` 设为 3 天前（状态为"待复盘"）
- `createdAt` 设为 7 天前
- `_isSample: true` 标记
- 紫色渐变卡片 + `✨ 示例决策 · 点击体验复盘` 标签
- 通过 `onboarding_sample_done` storage 标记控制只执行一次

### 4.2 首次提交成功引导页

首次提交决策后，不再 toast + 跳列表，改为全屏引导覆盖层：
- 成功确认：「决策已记录 · 到了复盘日，棱镜会提醒你回来看看」
- 引导卡片：「想先体验一下复盘 + AI 分析？」→ 「去体验复盘 →」按钮
- 次要入口：「先看看我的决策列表」
- 通过 `onboarding_submitted` storage 标记控制，后续提交恢复 toast + 跳列表

### 4.3 左滑操作引导

已复盘的示例决策卡片底部展示：
- `← 左滑可以「重写复盘」或「删除」`
- 右侧「知道了」按钮，点击后永久关闭
- 通过 `onboarding_swipe_hint_done` storage 标记控制

### 4.4 提交防抖修复

修复了 textarea `bindinput` 延迟导致首次点击提交无反应的问题：
- `submitDecision` 中不再依赖 `canSubmit` 状态，改为实时从 `data` 校验

### 4.5 提前复盘引导

引导用户在复盘日之前主动复盘：

- **首次展示**：醒目引导卡片（蓝紫渐变背景 + 💡 图标）
  - 标题：「不用等！有结果就能复盘」
  - 描述：「点击卡片随时开始复盘，体验 AI 分析」
  - 「知道了」按钮关闭
- **关闭后降级**：灰色低调文案 `已有结果？点击提前复盘 →`
- 通过 `onboarding_early_review_done` storage 标记控制
- 仅在"等待中"（未到期 & 未复盘）卡片上展示

### 4.6 空决策提交修复

修复点击两次提交按钮后出现空决策的严重 bug：

- **原因**：首次提交成功 → 引导页展示 → `finally` 块重置 `submitting` → 用户再次点击 → `draft_step1` 已清空 → 空决策写入数据库
- **三重防护**：
  1. 增加 `showSuccess` 检查：引导页展示后拒绝再次提交
  2. 增加 `step1.decision` 非空校验：即使 draft 被清空也能拦截
  3. `submitting` 仅在 `catch` 中重置为 false，成功后保持 true

### 4.7 开发者调试工具

长按导出按钮弹出开发者菜单：
- **查看统计**：决策总数、复盘率、破壁率、AI 模型分布、正负面分布
- **重置新手引导**：清除所有 onboarding storage 标记 + 删除示例决策，方便测试

---

## 当前状态总结

### 已实现

| 功能 | 状态 |
|------|------|
| 3 步决策输入 + 草稿保存 | ✅ |
| AI 智能标签（本地） | ✅ |
| 决策列表（搜索/筛选/分页） | ✅ |
| 左滑删除 + 重写复盘 | ✅ |
| 复盘流程（正面/负面双路径） | ✅ |
| AI 分析（DeepSeek + 混元 + 本地降级） | ✅ |
| 破壁反馈 | ✅ |
| 数据导出（JSON/Markdown） | ✅ |
| AI Agent 聊天 | ✅ |
| 认知偏差知识库 | ✅ |
| 新手引导系统 | ✅ |
| 提前复盘引导（双模式） | ✅ |
| 空决策提交防护 | ✅ |
| 开发者统计面板 | ✅ |

### 待实现

| 功能 | 优先级 |
|------|--------|
| 复盘提醒推送（微信订阅消息） | P1 |
| 分享卡片生成 | P2 |
| 短周期复盘选项（1 天 / 3 天） | P2 |
| 用户系统 / 个人中心 | P2 |
| 语音输入 | P3 |
| 行为原则画像 | P3 |
| 付费会员 | P3 |
